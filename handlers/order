from models.user import get_cart, set_cart, set_state
from services.telegram import tg_send_message
from services.sheets import save_order_to_sheets

def start_checkout_process(chat_id):
    cart = get_cart(chat_id)
    if not cart.get("items"):
        tg_send_message(chat_id, "üõí –í–∞—à –∫–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π. –î–æ–¥–∞–π—Ç–µ —â–æ—Å—å —ñ–∑ –º–µ–Ω—é! üçΩÔ∏è")
        return

    total = sum(float(it.get("price", 0.0)) * int(it.get("qty", 0)) for it in cart.get("items", []))
    if total < 300.0:  # MIN_ORDER_FOR_DELIVERY
        tg_send_message(chat_id, f"–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ —Å—É–º–∞ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ ‚Äî 300 –≥—Ä–Ω. –î–æ–¥–∞–π—Ç–µ —â–µ –Ω–∞ {300.0 - total:.2f} –≥—Ä–Ω! üòä")
        return

    tg_send_message(chat_id, "–í–≤–µ–¥—ñ—Ç—å –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É —É —Ñ–æ—Ä–º–∞—Ç—ñ +380XXXXXXXXX: üì±")
    set_state(chat_id, "awaiting_phone")
