# ü§ñ Hubsy Bot - AI-Powered Food Ordering Assistant

–†–æ–∑—É–º–Ω–∏–π Telegram-–±–æ—Ç –¥–ª—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —ó–∂—ñ –∑ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—î—é —à—Ç—É—á–Ω–æ–≥–æ —ñ–Ω—Ç–µ–ª–µ–∫—Ç—É (Gemini AI) —Ç–∞ Google Sheets.

## ‚ú® –§—É–Ω–∫—Ü—ñ—ó (Phase 2)

### üéØ –û—Å–Ω–æ–≤–Ω—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ:
- **üìã –Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–µ –º–µ–Ω—é** –∑ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è–º–∏ —Ç–∞ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—î—é
- **üîç –†–æ–∑—É–º–Ω–∏–π –ø–æ—à—É–∫** - "—Ö–æ—á—É —â–æ—Å—å —Å–æ–ª–æ–¥–∫–µ" ‚Üí AI –∑–Ω–∞–π–¥–µ –¥–µ—Å–µ—Ä—Ç–∏
- **‚ú® AI-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó** –Ω–∞ –æ—Å–Ω–æ–≤—ñ —ñ—Å—Ç–æ—Ä—ñ—ó –∑–∞–º–æ–≤–ª–µ–Ω—å
- **üõí –ö–æ—à–∏–∫** –∑ –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫–æ–º —Å—É–º–∏
- **üìú –Ü—Å—Ç–æ—Ä—ñ—è –∑–∞–º–æ–≤–ª–µ–Ω—å** - —à–≤–∏–¥–∫–µ –ø–æ–≤—Ç–æ—Ä–Ω–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
- **üî• –ü–æ–ø—É–ª—è—Ä–Ω—ñ —Å—Ç—Ä–∞–≤–∏** - —Ç—Ä–µ–∫—ñ–Ω–≥ –Ω–∞–π—á–∞—Å—Ç—ñ—à–∏—Ö –∑–∞–º–æ–≤–ª–µ–Ω—å
- **üí¨ –ü–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–∞—Ü—ñ—è** - –±–æ—Ç –∑–∞–ø–∞–º'—è—Ç–æ–≤—É—î —É–ø–æ–¥–æ–±–∞–Ω–Ω—è

### ü§ñ AI-Features:
1. **–†–æ–∑—É–º–Ω–∏–π –ø–æ—à—É–∫ —É –≤—ñ–ª—å–Ω—ñ–π —Ñ–æ—Ä–º—ñ**
   - "–•–æ—á—É –º'—è—Å–Ω–µ" ‚Üí –ø–æ–∫–∞–∑—É—î –±—É—Ä–≥–µ—Ä–∏/–ø—ñ—Ü—É –∑ –º'—è—Å–æ–º
   - "–©–æ—Å—å —à–≤–∏–¥–∫–µ" ‚Üí —Å—Ç—Ä–∞–≤–∏ –∑ –∫–æ—Ä–æ—Ç–∫–∏–º —á–∞—Å–æ–º –ø—Ä–∏–≥–æ—Ç—É–≤–∞–Ω–Ω—è
   
2. **–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó**
   - –ê–Ω–∞–ª—ñ–∑—É—î —ñ—Å—Ç–æ—Ä—ñ—é –∑–∞–º–æ–≤–ª–µ–Ω—å
   - –ü—Ä–æ–ø–æ–Ω—É—î —Å—Ö–æ–∂—ñ —Å—Ç—Ä–∞–≤–∏
   
3. **–î—ñ–∞–ª–æ–≥ –∑ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º**
   - –í—ñ–¥–ø–æ–≤—ñ–¥–∞—î –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –º–µ–Ω—é
   - –î–æ–ø–æ–º–∞–≥–∞—î –∑ –≤–∏–±–æ—Ä–æ–º

## üèóÔ∏è –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞

```
ferrik-bot/
‚îú‚îÄ‚îÄ main.py                 # Flask app + bot logic
‚îú‚îÄ‚îÄ config.py              # Configuration
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ telegram.py        # Telegram API wrapper
‚îÇ   ‚îú‚îÄ‚îÄ sheets.py          # Google Sheets integration
‚îÇ   ‚îî‚îÄ‚îÄ gemini.py          # AI (Gemini) integration
‚îú‚îÄ‚îÄ requirements.txt       # Dependencies
‚îú‚îÄ‚îÄ .gitignore            # Security
‚îî‚îÄ‚îÄ .env.example          # Environment template
```

## üìä Google Sheets Structure

### –ê—Ä–∫—É—à "–ú–µ–Ω—é":
| ID | –ö–∞—Ç–µ–≥–æ—Ä—ñ—è | –°—Ç—Ä–∞–≤–∏ | –û–ø–∏—Å | –¶—ñ–Ω–∞ | –†–µ—Å—Ç–æ—Ä–∞–Ω | –†–µ–π—Ç–∏–Ω–≥ | –ê–∫—Ç–∏–≤–Ω–∏–π |
|----|-----------|--------|------|------|----------|---------|----------|
| PZ001 | –ü—ñ—Ü–∞ | –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞ | –°–∏—Ä, —Ç–æ–º–∞—Ç–∏ | 150 | –ß–µ–ª–µ–Ω—Ç–∞–Ω–æ | 4.5 | –¢–∞–∫ |

### –ê—Ä–∫—É—à "–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è":
| ID –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è | Telegram User ID | –ß–∞—Å | –¢–æ–≤–∞—Ä–∏ (JSON) | –°—É–º–∞ | –°—Ç–∞—Ç—É—Å |
|---------------|------------------|-----|---------------|------|--------|
| ORD-xxx | 123456 | 2025-01-01 | [...] | 300 | –ù–æ–≤–µ |

## üöÄ Deployment (Render)

### 1. Environment Variables:

```bash
# Telegram
BOT_TOKEN=your_bot_token
WEBHOOK_SECRET=your_secure_secret_32chars

# Google Sheets
GOOGLE_SHEET_ID=your_spreadsheet_id
GOOGLE_CREDENTIALS_JSON={"type":"service_account",...}

# AI
GEMINI_API_KEY=your_gemini_key
GEMINI_MODEL_NAME=gemini-2.0-flash-exp

# Optional
OPERATOR_CHAT_ID=your_telegram_id
DEBUG=False
PORT=10000
```

### 2. –ó–≥–µ–Ω–µ—Ä—É–π—Ç–µ WEBHOOK_SECRET:
```python
import secrets
print(secrets.token_urlsafe(32))
```

### 3. –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å webhook:
```bash
curl -X POST "https://api.telegram.org/bot<TOKEN>/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://your-app.onrender.com/webhook",
    "secret_token": "YOUR_WEBHOOK_SECRET"
  }'
```

## üîí –ë–µ–∑–ø–µ–∫–∞

- ‚úÖ –°–µ–∫—Ä–µ—Ç–∏ –ù–ï –≤ –∫–æ–¥—ñ (—Ç—ñ–ª—å–∫–∏ ENV)
- ‚úÖ Webhook authentication —á–µ—Ä–µ–∑ X-Telegram-Bot-Api-Secret-Token
- ‚úÖ HTML escaping –¥–ª—è –∑–∞—Ö–∏—Å—Ç—É –≤—ñ–¥ injection
- ‚úÖ Thread-safe –æ–ø–µ—Ä–∞—Ü—ñ—ó –∑ –∫–æ—Ä–∑–∏–Ω–∞–º–∏
- ‚úÖ Rate limiting –≥–æ—Ç–æ–≤–∏–π

## üìà –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞

–ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ç—Ä–µ–∫–∞—î:
- üìä –ü–æ–ø—É–ª—è—Ä–Ω—ñ—Å—Ç—å —Å—Ç—Ä–∞–≤ (Counter)
- üìú –Ü—Å—Ç–æ—Ä—ñ—é –∑–∞–º–æ–≤–ª–µ–Ω—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
- üéØ –£–ø–æ–¥–æ–±–∞–Ω–Ω—è (—è–∫—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –æ–±–∏—Ä–∞—é—Ç—å)

## üõ†Ô∏è Local Development

```bash
# 1. Clone
git clone https://github.com/ferrik/ferrik-bot.git
cd ferrik-bot

# 2. Install
pip install -r requirements.txt

# 3. Create .env
cp .env.example .env
# –ó–∞–ø–æ–≤–Ω—ñ—Ç—å –∑–º—ñ–Ω–Ω—ñ

# 4. Run
python main.py
```

## üìù User Flow

```
/start
  ‚Üì
–ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é
  ‚Üì
‚îú‚îÄ‚Üí üçΩÔ∏è –ú–µ–Ω—é ‚Üí –ö–∞—Ç–µ–≥–æ—Ä—ñ—ó ‚Üí –ö–∞—Ä—É—Å–µ–ª—å —Å—Ç—Ä–∞–≤ ‚Üí –î–æ–¥–∞—Ç–∏
‚îú‚îÄ‚Üí üî• –ü–æ–ø—É–ª—è—Ä–Ω–µ ‚Üí –¢–æ–ø-3 —Å—Ç—Ä–∞–≤–∏
‚îú‚îÄ‚Üí üîç –ü–æ—à—É–∫ (AI) ‚Üí –†–µ–∑—É–ª—å—Ç–∞—Ç–∏
‚îú‚îÄ‚Üí ‚ú® AI-–ü–æ—Ä–∞–¥–∞ ‚Üí –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó
‚îú‚îÄ‚Üí üõí –ö–æ—à–∏–∫ ‚Üí –û—Ñ–æ—Ä–º–∏—Ç–∏ ‚Üí ‚úÖ –ì–æ—Ç–æ–≤–æ
‚îî‚îÄ‚Üí üìú –Ü—Å—Ç–æ—Ä—ñ—è ‚Üí –ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
```

## üé® UX Improvements (Phase 2)

1. **FSM (Finite State Machine)** - –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
2. **–ö–∞—Ä—É—Å–µ–ª—å –∑ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—î—é** - ‚¨ÖÔ∏è 1/5 ‚û°Ô∏è
3. **–ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"** –Ω–∞ –∫–æ–∂–Ω–æ–º—É –∫—Ä–æ—Ü—ñ
4. **–ü–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–∞—Ü—ñ—è** - "–ü—Ä–∏–≤—ñ—Ç, –Ü–º'—è! –ë–∞—á—É —Ç–∏ –ª—é–±–∏—à –ü—ñ—Ü—É üòâ"
5. **–Ü—Å—Ç–æ—Ä—ñ—è** - —à–≤–∏–¥–∫–µ –ø–æ–≤—Ç–æ—Ä–Ω–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è

## ü§ñ AI Integration

### Gemini API –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è:

1. **–ü–æ—à—É–∫** - —Ä–æ–∑—É–º—ñ—î –∑–∞–ø–∏—Ç–∏ —É –≤—ñ–ª—å–Ω—ñ–π —Ñ–æ—Ä–º—ñ
2. **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó** - –∞–Ω–∞–ª—ñ–∑ —ñ—Å—Ç–æ—Ä—ñ—ó + –ø–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–∞—Ü—ñ—è
3. **–î—ñ–∞–ª–æ–≥** - –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤

### –ü—Ä–æ–º–ø—Ç–∏ –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω—ñ –¥–ª—è:
- –ö–æ—Ä–æ—Ç–∫—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ (2-3 —Ä–µ—á–µ–Ω–Ω—è)
- –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞
- –î—Ä—É–∂–Ω—ñ–π —Ç–æ–Ω
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ñ—Å—Ç—å

## üìä Performance

- **Menu cache**: 5 —Ö–≤–∏–ª–∏–Ω TTL
- **Thread-safe**: RLock –¥–ª—è –∫–æ—Ä–∑–∏–Ω/—Å—Ç–∞–Ω—ñ–≤
- **Retry logic**: 2 —Å–ø—Ä–æ–±–∏ –¥–ª—è AI requests
- **Logging**: Structured logging –∑ timestamp

## üîÆ Roadmap (Phase 3)

- [ ] üì∏ –§–æ—Ç–æ —Å—Ç—Ä–∞–≤ –∑ Google Sheets
- [ ] üí≥ –û–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç–∞ (LiqPay/Stripe)
- [ ] üìç –í—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –¥–æ—Å—Ç–∞–≤–∫–∏
- [ ] üë§ –ü—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
- [ ] üéÅ –ü—Ä–æ–º–æ–∫–æ–¥–∏ —Ç–∞ –∑–Ω–∏–∂–∫–∏
- [ ] üìä Admin Dashboard (analytics)
- [ ] üåê Multi-restaurant support
- [ ] üì± Push-–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —Å—Ç–∞—Ç—É—Å

## üÜò Troubleshooting

### –ë–æ—Ç –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î:
```bash
# 1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ webhook
curl "https://api.telegram.org/bot<TOKEN>/getWebhookInfo"

# 2. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ health
curl https://your-app.onrender.com/health

# 3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ –Ω–∞ Render
# Dashboard ‚Üí Logs
```

### –ú–µ–Ω—é –ø–æ—Ä–æ–∂–Ω—î:
1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ GOOGLE_SHEET_ID
2. –î–æ–¥–∞–π—Ç–µ Service Account email –¥–æ —Ç–∞–±–ª–∏—Ü—ñ (Share ‚Üí Editor)
3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∞—Ä–∫—É—à "–ú–µ–Ω—é" —ñ—Å–Ω—É—î
4. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–ª–æ–Ω–∫–∞ "–ê–∫—Ç–∏–≤–Ω–∏–π" = "–¢–∞–∫"

### AI –Ω–µ –ø—Ä–∞—Ü—é—î:
1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ GEMINI_API_KEY
2. –ó–º—ñ–Ω—ñ—Ç—å GEMINI_MODEL_NAME –Ω–∞ `gemini-2.0-flash-exp`
3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–≤–æ—Ç–∏ –Ω–∞ https://aistudio.google.com

## üìû Support

- Issues: https://github.com/ferrik/ferrik-bot/issues
- Telegram: @ferrikfoot_bot

## üìÑ License

MIT License - –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —è–∫ —Ö–æ—á–µ—Ç–µ!

---

**Made with üíô in Ukraine**# üîß –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –ø–æ –∑–∞–º—ñ–Ω—ñ —Ñ–∞–π–ª—ñ–≤

## üìã CHECKLIST - –Ø–∫—ñ —Ñ–∞–π–ª–∏ –∑–∞–º—ñ–Ω–∏—Ç–∏

### ‚úÖ –ü–û–í–ù–Ü–°–¢–Æ –ó–ê–ú–Ü–ù–ò–¢–ò (—Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –≤–µ—Å—å –∫–æ–¥):

1. **`main.py`** ‚Üê –ê—Ä—Ç–µ—Ñ–∞–∫—Ç `full_main_py`
2. **`config.py`** ‚Üê –ê—Ä—Ç–µ—Ñ–∞–∫—Ç `full_config_py`
3. **`services/sheets.py`** ‚Üê –ê—Ä—Ç–µ—Ñ–∞–∫—Ç `full_sheets_py`
4. **`services/telegram.py`** ‚Üê –ê—Ä—Ç–µ—Ñ–∞–∫—Ç `full_telegram_py`
5. **`services/gemini.py`** ‚Üê –ê—Ä—Ç–µ—Ñ–∞–∫—Ç `full_gemini_py`
6. **`services/database.py`** ‚Üê –ê—Ä—Ç–µ—Ñ–∞–∫—Ç `full_database_py`

### ‚úÖ –ù–û–í–Ü –§–ê–ô–õ–ò (—Å—Ç–≤–æ—Ä–∏—Ç–∏ —ñ –¥–æ–¥–∞—Ç–∏ –∫–æ–¥):

7. **`utils/html_formatter.py`** ‚Üê –ê—Ä—Ç–µ—Ñ–∞–∫—Ç `full_html_formatter`
8. **`utils/price_handler.py`** ‚Üê –ê—Ä—Ç–µ—Ñ–∞–∫—Ç `full_price_handler`
9. **`config/field_mapping.py`** ‚Üê –ê—Ä—Ç–µ—Ñ–∞–∫—Ç `full_field_mapping`
10. **`tests/test_quick.py`** ‚Üê –ê—Ä—Ç–µ—Ñ–∞–∫—Ç `full_quick_test`
11. **`run_after_install.py`** ‚Üê –ê—Ä—Ç–µ—Ñ–∞–∫—Ç `final_integration_test`

### ‚úÖ –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø:

12. **`.env.example`** ‚Üê –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑ –ø—Ä–∏–∫–ª–∞–¥—É –≤–∏—â–µ
13. **`.gitignore`** ‚Üê –û–Ω–æ–≤–∏—Ç–∏ (–¥–æ–¥–∞—Ç–∏ —Ä—è–¥–∫–∏)
14. **`requirements.txt`** ‚Üê –û–Ω–æ–≤–∏—Ç–∏ (–¥–æ–¥–∞—Ç–∏ redis)

---

## üöÄ –®–í–ò–î–ö–ò–ô –°–¢–ê–†–¢ (3 –ø—Ä–æ—Å—Ç–∏—Ö –∫—Ä–æ–∫–∏)

### –ö—Ä–æ–∫ 1: Backup
```bash
cd ~/ferrik-bot
git add .
git commit -m "backup: before critical fixes"
git checkout -b fix/security-and-precision
```

### –ö—Ä–æ–∫ 2: –°—Ç–≤–æ—Ä–∏—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É
```bash
mkdir -p utils config state tests data
touch utils/__init__.py
touch config/__init__.py
touch state/__init__.py
touch tests/__init__.py
```

### –ö—Ä–æ–∫ 3: –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ —Ñ–∞–π–ª–∏
–í—ñ–¥–∫—Ä–∏–π—Ç–µ –∫–æ–∂–µ–Ω –∞—Ä—Ç–µ—Ñ–∞–∫—Ç —ñ —Å–∫–æ–ø—ñ—é–π—Ç–µ **–í–ï–°–¨ –ö–û–î**:

#### 3.1 –ù–æ–≤—ñ –º–æ–¥—É–ª—ñ (utils/config):
- `utils/html_formatter.py` ‚Üê full_html_formatter
- `utils/price_handler.py` ‚Üê full_price_handler
- `config/field_mapping.py` ‚Üê full_field_mapping

#### 3.2 –û—Å–Ω–æ–≤–Ω—ñ —Ñ–∞–π–ª–∏ (–ó–ê–ú–Ü–ù–ê):
- `main.py` ‚Üê full_main_py ‚ö†Ô∏è **BACKUP –ø–µ—Ä–µ–¥ –∑–∞–º—ñ–Ω–æ—é!**
- `config.py` ‚Üê full_config_py
- `services/sheets.py` ‚Üê full_sheets_py
- `services/telegram.py` ‚Üê full_telegram_py
- `services/gemini.py` ‚Üê full_gemini_py
- `services/database.py` ‚Üê full_database_py

#### 3.3 –¢–µ—Å—Ç–∏:
- `tests/test_quick.py` ‚Üê full_quick_test
- `run_after_install.py` ‚Üê final_integration_test

---

## ‚öôÔ∏è –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø

### 1. –û–Ω–æ–≤–∏—Ç–∏ requirements.txt
```bash
# –î–æ–¥–∞–π—Ç–µ —Ü—ñ —Ä—è–¥–∫–∏:
redis==5.0.0
```

```bash
pip install -r requirements.txt
```

### 2. –ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ .env
```bash
cp .env.example .env
nano .env
```

**–û–±–æ–≤'—è–∑–∫–æ–≤–æ:**
- `BOT_TOKEN=` ‚Üê –≤—ñ–¥ @BotFather
- `WEBHOOK_SECRET=` ‚Üê –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏: `python run_after_install.py --secret`
- `GOOGLE_SHEET_ID=`
- `GOOGLE_CREDENTIALS_JSON=`
- `OPERATOR_CHAT_ID=`

### 3. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏
```bash
# –®–≤–∏–¥–∫—ñ —Ç–µ—Å—Ç–∏
python tests/test_quick.py

# –§—ñ–Ω–∞–ª—å–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞
python run_after_install.py

# –ú–∞—î –≤–∏–≤–µ—Å—Ç–∏:
# ‚úÖ Passed: 10
# ‚ùå Failed: 0
```

---

## üß™ –¢–ï–°–¢–£–í–ê–ù–ù–Ø

### –ë–∞–∑–æ–≤—ñ —Ç–µ—Å—Ç–∏
```bash
# 1. –Ü–º–ø–æ—Ä—Ç–∏
python -c "from utils.html_formatter import escape_field; print('‚úÖ OK')"
python -c "from utils.price_handler import parse_price; print('‚úÖ OK')"
python -c "import main; print('‚úÖ OK')"

# 2. Config
python -c "import config; print('‚úÖ OK')"

# 3. XSS —Ç–µ—Å—Ç
python -c "from utils.html_formatter import escape_field; assert '<script>' not in escape_field('<script>'); print('‚úÖ XSS blocked')"

# 4. Decimal —Ç–µ—Å—Ç
python -c "from utils.price_handler import parse_price; from decimal import Decimal; assert parse_price('0.1') + parse_price('0.2') == Decimal('0.3'); print('‚úÖ Decimal works')"
```

### –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –±–æ—Ç–∞
```bash
python main.py
```

**–û—á—ñ–∫—É—î—Ç—å—Å—è –≤–∏–≤—ñ–¥:**
```
====================================
INITIALIZING BOT
====================================
Loading menu...
‚úÖ Menu loaded: XX items
Setting up webhook...
‚úÖ Webhook configured
====================================
‚úÖ BOT INITIALIZED SUCCESSFULLY
====================================
```

---

## üìä –©–û –í–ò–ü–†–ê–í–õ–ï–ù–û

### üîê Security (CRITICAL):
- ‚úÖ **XSS –∑–∞—Ö–∏—Å—Ç** - –≤—Å—ñ user –¥–∞–Ω—ñ escaped
- ‚úÖ **Webhook secret** - –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∏ –∫–æ–∂–Ω–æ–º—É –∑–∞–ø–∏—Ç—ñ
- ‚úÖ **Input —Å–∞–Ω—ñ—Ç–∏–∑–∞—Ü—ñ—è** - –æ—á–∏—â–µ–Ω–Ω—è HTML –∑ –∑–∞–ø–∏—Ç—ñ–≤

### üí∞ Precision (CRITICAL):
- ‚úÖ **Decimal –∑–∞–º—ñ—Å—Ç—å float** - —Ç–æ—á–Ω—ñ—Å—Ç—å 0.1 + 0.2 = 0.3
- ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è Sheets** - –±–µ–∑ 0.30000004
- ‚úÖ **–§—ñ–Ω–∞–Ω—Å–æ–≤–∞ —Ç–æ—á–Ω—ñ—Å—Ç—å** - –≤—Å—ñ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∏ —Ç–æ—á–Ω—ñ

### üîÑ Architecture:
- ‚úÖ **Field mapping** - —É–Ω—ñ—Ñ—ñ–∫–æ–≤–∞–Ω—ñ –∫–ª—é—á—ñ
- ‚úÖ **Backward compatibility** - —Å—Ç–∞—Ä–∏–π –∫–æ–¥ –ø—Ä–∞—Ü—é—î
- ‚úÖ **–ö—Ä–∞—âa –æ–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫** - graceful degradation

### üìù Code Quality:
- ‚úÖ **Type hints** - –¥–µ –º–æ–∂–ª–∏–≤–æ
- ‚úÖ **Docstrings** - –≤—Å—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤–∞–Ω—ñ
- ‚úÖ **Logging** - –¥–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è
- ‚úÖ **Error handling** - proper try/except

---

## üîç –ü–ï–†–ï–í–Ü–†–ö–ê –ü–Ü–°–õ–Ø –ó–ê–ü–£–°–ö–£

### 1. Security —Ç–µ—Å—Ç –≤ Telegram:
```
–í—ñ–¥–ø—Ä–∞–≤—Ç–µ –±–æ—Ç—É: <script>alert(1)</script>
–û—á—ñ–∫—É—î—Ç—å—Å—è: —Ç–µ–∫—Å—Ç –±—É–¥–µ escaped (&lt;script&gt;...)
```

### 2. Precision —Ç–µ—Å—Ç:
```
1. –î–æ–¥–∞–π—Ç–µ —Ç–æ–≤–∞—Ä —Ü—ñ–Ω–æ—é 120.50 –≥—Ä–Ω (2 —à—Ç)
2. –î–æ–¥–∞–π—Ç–µ —Ç–æ–≤–∞—Ä —Ü—ñ–Ω–æ—é 99.99 –≥—Ä–Ω (1 —à—Ç)
3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ—Ä–∑–∏–Ω—É
–û—á—ñ–∫—É—î—Ç—å—Å—è: –†–∞–∑–æ–º: 340.99 –≥—Ä–Ω (–¢–û–ß–ù–û, –Ω–µ 340.9900000004)
```

### 3. Webhook —Ç–µ—Å—Ç:
```bash
# –ë–µ–∑ secret - –º–∞—î –±—É—Ç–∏ 401
curl -X POST http://localhost:5000/webhook

# –ó secret - –º–∞—î –ø—Ä–∞—Ü—é–≤–∞—Ç–∏
curl -X POST http://localhost:5000/webhook \
  -H "X-Telegram-Bot-Api-Secret-Token: $WEBHOOK_SECRET"
```

### 4. Sheets —Ç–µ—Å—Ç:
```
1. –°—Ç–≤–æ—Ä—ñ—Ç—å —Ç–µ—Å—Ç–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
2. –í—ñ–¥–∫—Ä–∏–π—Ç–µ Google Sheets
3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ Orders –ª–∏—Å—Ç
–û—á—ñ–∫—É—î—Ç—å—Å—è: —Ü—ñ–Ω–∏ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ —è–∫ 120.50 (string, –Ω–µ float)
```

---

## üêõ TROUBLESHOOTING

### –ü—Ä–æ–±–ª–µ–º–∞: ImportError
```bash
# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É
ls -la utils/
ls -la config/

# –ú–∞—î –±—É—Ç–∏ __init__.py
touch utils/__init__.py
touch config/__init__.py
```

### –ü—Ä–æ–±–ª–µ–º–∞: Config validation failed
```bash
# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ .env
python -c "import os; from dotenv import load_dotenv; load_dotenv(); print(os.getenv('BOT_TOKEN'))"
```

### –ü—Ä–æ–±–ª–µ–º–∞: Webhook –Ω–µ –ø—Ä–∞—Ü—é—î
```bash
# –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
python -c "from services.telegram import tg_get_webhook_info; tg_get_webhook_info()"

# –ü–µ—Ä–µ–≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏
python -c "from services.telegram import setup_webhook_safe; setup_webhook_safe()"
```

### –ü—Ä–æ–±–ª–µ–º–∞: Sheets –Ω–µ –ø—Ä–∞—Ü—é—î
```bash
# –¢–µ—Å—Ç –∑'—î–¥–Ω–∞–Ω–Ω—è
python -c "from services.sheets import test_sheets_connection; test_sheets_connection()"
```

### –ü—Ä–æ–±–ª–µ–º–∞: –¢–µ—Å—Ç–∏ –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç—å
```bash
# –î–µ—Ç–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è
python run_after_install.py --info

# –ü–æ–∫–∞–∑–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏
python run_after_install.py --next
```

---

## üì¶ COMMIT & DEPLOY

```bash
# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∑–º—ñ–Ω–∏
git status
git diff main.py  # –ü–æ–¥–∏–≤–∏—Ç–∏—Å—å —â–æ –∑–º—ñ–Ω–∏–ª–æ—Å—å

# –î–æ–¥–∞—Ç–∏ –≤—Å–µ
git add .

# Commit
git commit -m "fix(critical): Security and precision improvements

- Fixed XSS vulnerability in HTML formatting
- Decimal instead of float for prices (financial precision)
- Unified field mapping system
- Improved webhook security
- Better error handling and logging

Tested: all unit tests pass
Fixes: #ISSUE_NUMBER"

# Push
git push origin fix/security-and-precision

# –°—Ç–≤–æ—Ä–∏—Ç–∏ Pull Request –Ω–∞ GitHub
```

---

## üéØ PRODUCTION DEPLOY

### –Ø–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ Heroku:
```bash
# –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ buildpack
heroku buildpacks:set heroku/python

# –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ env vars
heroku config:set BOT_TOKEN="your_token"
heroku config:set WEBHOOK_SECRET="your_secret"
# ... —ñ–Ω—à—ñ –∑–º—ñ–Ω–Ω—ñ

# Deploy
git push heroku main

# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ª–æ–≥–∏
heroku logs --tail
```

### –Ø–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ VPS:
```bash
# Gunicorn –¥–ª—è production
gunicorn -w 4 -b 0.0.0.0:$PORT main:app

# –ê–±–æ –∑ Systemd service
sudo systemctl restart telegram-bot
sudo systemctl status telegram-bot
```

---

## üìö –î–û–î–ê–¢–ö–û–í–Ü –†–ï–°–£–†–°–ò

### –°—Ç–≤–æ—Ä–µ–Ω—ñ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∏:
1. `full_main_py` - –ü–æ–≤–Ω–∏–π main.py
2. `full_config_py` - –ü–æ–≤–Ω–∏–π config.py
3. `full_sheets_py` - –ü–æ–≤–Ω–∏–π services/sheets.py
4. `full_telegram_py` - –ü–æ–≤–Ω–∏–π services/telegram.py
5. `full_gemini_py` - –ü–æ–≤–Ω–∏–π services/gemini.py
6. `full_database_py` - –ü–æ–≤–Ω–∏–π services/database.py
7. `full_html_formatter` - utils/html_formatter.py
8. `full_price_handler` - utils/price_handler.py
9. `full_field_mapping` - config/field_mapping.py
10. `full_quick_test` - tests/test_quick.py
11. `final_integration_test` - run_after_install.py
12. `installation_checklist` - –î–µ—Ç–∞–ª—å–Ω–∏–π checklist

### –†–∞–Ω—ñ—à–µ —Å—Ç–≤–æ—Ä–µ–Ω—ñ (–¥–ª—è reference):
- Migration Guide - –¥–ª—è –±–µ–∑–ø–µ—á–Ω–æ–≥–æ deploy
- Fix Checklist - –ø–æ–≤–Ω–∏–π —Å–ø–∏—Å–æ–∫ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å
- Test Examples - –ø—Ä–∏–∫–ª–∞–¥–∏ —Ç–µ—Å—Ç—ñ–≤

---

## ‚úÖ SUCCESS CRITERIA

–í—Å–µ –≥–æ—Ç–æ–≤–æ —è–∫—â–æ:
- [ ] –í—Å—ñ —Ñ–∞–π–ª–∏ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω—ñ
- [ ] `python run_after_install.py` –ø–æ–∫–∞–∑—É—î 0 failed
- [ ] –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è –±–µ–∑ –ø–æ–º–∏–ª–æ–∫
- [ ] XSS —Ç–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω–æ (escaped)
- [ ] Decimal —Ç–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω–æ (0.1+0.2=0.3)
- [ ] Webhook –ø—Ä–∞—Ü—é—î (401 –±–µ–∑ secret)
- [ ] –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- [ ] –¶—ñ–Ω–∏ –≤ Sheets –±–µ–∑ 0.300000004

---

## üÜò –ü–û–¢–†–Ü–ë–ù–ê –î–û–ü–û–ú–û–ì–ê?

–Ø–∫—â–æ —â–æ—Å—å –Ω–µ –ø—Ä–∞—Ü—é—î:
1. –ó–∞–ø—É—Å—Ç—ñ—Ç—å `python run_after_install.py --info`
2. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏: `tail -f bot.log`
3. –ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –ø–æ–º–∏–ª–∫–∏ –≤–∏—â–µ –≤ checklist
4. –ù–∞–ø–∏—à—ñ—Ç—å –º–µ–Ω—ñ –∑ –¥–µ—Ç–∞–ª—è–º–∏ –ø–æ–º–∏–ª–∫–∏

**–í—Å–µ –≥–æ—Ç–æ–≤–æ –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è!** –£—Å–ø—ñ—Ö—ñ–≤! üöÄ