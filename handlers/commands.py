import os
import logging
import requests
from datetime import datetime

logger = logging.getLogger('ferrik')

TELEGRAM_BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')

def send_message(chat_id, text, reply_markup=None):
    """–í—ñ–¥–ø—Ä–∞–≤–ª—è—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ Telegram"""
    url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"
    payload = {
        "chat_id": chat_id,
        "text": text,
        "parse_mode": "HTML"
    }
    
    if reply_markup:
        payload["reply_markup"] = reply_markup
    
    try:
        response = requests.post(url, json=payload, timeout=10)
        response.raise_for_status()
        logger.info(f"‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç {chat_id}")
        return response.json()
    except Exception as e:
        logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: {e}")
        return None


def handle_start(chat_id, user):
    """–û–±—Ä–æ–±–Ω–∏–∫ –∫–æ–º–∞–Ω–¥–∏ /start"""
    username = user.get('first_name', '–¥—Ä—É–∂–µ')
    
    welcome_text = f"""
üëã <b>–í—ñ—Ç–∞—é, {username}!</b>

–Ø <b>FerrikFootBot</b> - –≤–∞—à –ø–æ–º—ñ—á–Ω–∏–∫ —É –∑–∞–º–æ–≤–ª–µ–Ω–Ω—ñ —ó–∂—ñ! üçï

<b>–©–æ —è –≤–º—ñ—é:</b>
üçî –ü–æ–∫–∞–∑–∞—Ç–∏ –º–µ–Ω—é
üìù –ü—Ä–∏–π–Ω—è—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
üí¨ –í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏ –Ω–∞ –≤–∞—à—ñ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è
ü§ñ –î–æ–ø–æ–º–æ–≥—Ç–∏ –∑ –≤–∏–±–æ—Ä–æ–º —Å—Ç—Ä–∞–≤ —á–µ—Ä–µ–∑ AI

<b>–î–æ—Å—Ç—É–ø–Ω—ñ –∫–æ–º–∞–Ω–¥–∏:</b>
/menu - –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –º–µ–Ω—é
/order - –ó—Ä–æ–±–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
/help - –î–æ–ø–æ–º–æ–≥–∞

–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à—ñ—Ç—å –º–µ–Ω—ñ, —â–æ –≤–∞—Å —Ü—ñ–∫–∞–≤–∏—Ç—å! üòä
"""
    
    # –ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∞ –∑ —à–≤–∏–¥–∫–∏–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏
    keyboard = {
        "keyboard": [
            [{"text": "üçï –ú–µ–Ω—é"}, {"text": "üìù –ó–∞–º–æ–≤–∏—Ç–∏"}],
            [{"text": "‚ÑπÔ∏è –î–æ–ø–æ–º–æ–≥–∞"}]
        ],
        "resize_keyboard": True
    }
    
    send_message(chat_id, welcome_text, keyboard)


def handle_help(chat_id, user):
    """–û–±—Ä–æ–±–Ω–∏–∫ –∫–æ–º–∞–Ω–¥–∏ /help"""
    help_text = """
<b>üìñ –î–æ–≤—ñ–¥–∫–∞ FerrikFootBot</b>

<b>–û—Å–Ω–æ–≤–Ω—ñ –∫–æ–º–∞–Ω–¥–∏:</b>
/start - –ü–æ—á–∞—Ç–∏ —Ä–æ–±–æ—Ç—É –∑ –±–æ—Ç–æ–º
/menu - –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –º–µ–Ω—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω—É
/order - –ó—Ä–æ–±–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
/help - –ü–æ–∫–∞–∑–∞—Ç–∏ —Ü—é –¥–æ–≤—ñ–¥–∫—É

<b>–Ø–∫ –∑—Ä–æ–±–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:</b>
1Ô∏è‚É£ –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å /menu —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ —Å—Ç—Ä–∞–≤–∏
2Ô∏è‚É£ –ù–∞–ø–∏—à—ñ—Ç—å –Ω–∞–∑–≤—É —Å—Ç—Ä–∞–≤–∏ –∞–±–æ –æ–ø–∏—à—ñ—Ç—å, —â–æ —Ö–æ—á–µ—Ç–µ
3Ô∏è‚É£ –Ø –¥–æ–ø–æ–º–æ–∂—É –æ—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è

<b>–†–æ–∑—É–º–Ω–∏–π –∞—Å–∏—Å—Ç–µ–Ω—Ç:</b>
–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à—ñ—Ç—å –º–µ–Ω—ñ –∑–≤–∏—á–∞–π–Ω–∏–º —Ç–µ–∫—Å—Ç–æ–º:
‚Ä¢ "–©–æ —É –≤–∞—Å —î –∑ –º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç–∞–º–∏?"
‚Ä¢ "–ü–æ—Ä–∞–¥—å —â–æ—Å—å —Å–º–∞—á–Ω–µ"
‚Ä¢ "–•–æ—á—É –ø—ñ—Ü—É –∑ –≥—Ä–∏–±–∞–º–∏"

–Ø –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é AI, —â–æ–± –∑—Ä–æ–∑—É–º—ñ—Ç–∏ –≤–∞—à—ñ –ø–æ–±–∞–∂–∞–Ω–Ω—è! ü§ñ

<b>–ü—ñ–¥—Ç—Ä–∏–º–∫–∞:</b>
–Ø–∫—â–æ –≤–∏–Ω–∏–∫–ª–∏ –ø–∏—Ç–∞–Ω–Ω—è - –ø–∏—à—ñ—Ç—å @ferrik
"""
    
    send_message(chat_id, help_text)


def handle_menu(chat_id, user):
    """–û–±—Ä–æ–±–Ω–∏–∫ –∫–æ–º–∞–Ω–¥–∏ /menu"""
    try:
        from services.sheets import get_menu, is_sheets_connected
        
        if not is_sheets_connected():
            menu_text = """
<b>üçΩ –ù–∞—à–µ –º–µ–Ω—é:</b>

<b>üçï –ü—ñ—Ü–∞:</b>
‚Ä¢ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞ - 150 –≥—Ä–Ω
‚Ä¢ –ü–µ–ø–µ—Ä–æ–Ω—ñ - 180 –≥—Ä–Ω
‚Ä¢ –ß–æ—Ç–∏—Ä–∏ —Å–∏—Ä–∞ - 200 –≥—Ä–Ω

<b>üçù –ü–∞—Å—Ç–∞:</b>
‚Ä¢ –ö–∞—Ä–±–æ–Ω–∞—Ä–∞ - 140 –≥—Ä–Ω
‚Ä¢ –ë–æ–ª–æ–Ω—å—î–∑–µ - 130 –≥—Ä–Ω

<b>ü•ó –°–∞–ª–∞—Ç–∏:</b>
‚Ä¢ –¶–µ–∑–∞—Ä - 120 –≥—Ä–Ω
‚Ä¢ –ì—Ä–µ—Ü—å–∫–∏–π - 110 –≥—Ä–Ω

<b>ü•§ –ù–∞–ø–æ—ó:</b>
‚Ä¢ Coca-Cola - 40 –≥—Ä–Ω
‚Ä¢ –°—ñ–∫ - 35 –≥—Ä–Ω

<i>‚ö†Ô∏è –ú–µ–Ω—é —Å—Ç–∞—Ç–∏—á–Ω–µ (Google Sheets –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ)</i>
"""
            send_message(chat_id, menu_text)
            return
        
        # –û—Ç—Ä–∏–º—É—î–º–æ –º–µ–Ω—é –∑ Google Sheets
        menu_data = get_menu()
        
        if not menu_data:
            send_message(chat_id, "‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–µ–Ω—é. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.")
            return
        
        # –§–æ—Ä–º—É—î–º–æ —Ç–µ–∫—Å—Ç –º–µ–Ω—é
        menu_text = "<b>üçΩ –ù–∞—à–µ –º–µ–Ω—é:</b>\n\n"
        
        current_category = None
        for item in menu_data:
            category = item.get('–ö–∞—Ç–µ–≥–æ—Ä—ñ—è', '')
            name = item.get('–ù–∞–∑–≤–∞', '')
            price = item.get('–¶—ñ–Ω–∞', '')
            
            if category != current_category:
                menu_text += f"\n<b>{category}:</b>\n"
                current_category = category
            
            menu_text += f"‚Ä¢ {name} - {price} –≥—Ä–Ω\n"
        
        # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
        keyboard = {
            "inline_keyboard": [
                [{"text": "üìù –ó—Ä–æ–±–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è", "callback_data": "make_order"}]
            ]
        }
        
        send_message(chat_id, menu_text, keyboard)
        
    except Exception as e:
        logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–æ–∫–∞–∑—É –º–µ–Ω—é: {e}", exc_info=True)
        send_message(chat_id, "‚ö†Ô∏è –í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –º–µ–Ω—é")


def handle_order(chat_id, user):
    """–û–±—Ä–æ–±–Ω–∏–∫ –∫–æ–º–∞–Ω–¥–∏ /order"""
    order_text = """
<b>üìù –û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</b>

–©–æ–± –∑—Ä–æ–±–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à—ñ—Ç—å –º–µ–Ω—ñ:
‚Ä¢ –ù–∞–∑–≤–∏ —Å—Ç—Ä–∞–≤ –∑ –º–µ–Ω—é
‚Ä¢ –ê–±–æ –æ–ø–∏—à—ñ—Ç—å, —â–æ —Ö–æ—á–µ—Ç–µ, —ñ —è –¥–æ–ø–æ–º–æ–∂—É –≤–∏–±—Ä–∞—Ç–∏

<b>–ü—Ä–∏–∫–ª–∞–¥:</b>
"–ü—ñ—Ü—É –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞, —Å–∞–ª–∞—Ç –¶–µ–∑–∞—Ä —ñ –ö–æ–ª—É"

–ê–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ –Ω–∞—à AI-–∞—Å–∏—Å—Ç–µ–Ω—Ç:
"–•–æ—á—É —â–æ—Å—å –ª–µ–≥–∫–µ –Ω–∞ –æ–±—ñ–¥" ü§ñ

–ß–µ–∫–∞—é –Ω–∞ –≤–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è! üòä
"""
    
    send_message(chat_id, order_text)